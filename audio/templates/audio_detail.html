{% extends "layout.html" %}
{% block title %}‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á | Sound Remover{% endblock %}
{% block content %}

<div class="container py-4">
  <h3 class="fw-bold mb-3">üéµ {{ audio.original_file.name|cut:"uploads/originals/" }}</h3>
  <div class="d-flex justify-content-end mb-3">
    <form method="post" action="{% url 'delete_audio' audio.id %}">
      {% csrf_token %}
      {% if perms.audio.delete_audiofile and is_owner%}
      <button type="submit" class="btn btn-danger">üóëÔ∏è Delete</button>
      {% endif %}
    </form>
  </div>

  <p><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong>
    {% if audio.status == 'processed' %}
    <span class="badge bg-success">Success</span>
    {% elif audio.status == 'pending' %}
    <span class="badge bg-warning text-dark">Pending</span>
    {% else %}
    <span class="badge bg-danger">Failed</span>
    {% endif %}
  </p>
  <p><strong>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> {{ audio.uploaded_at|date:"d/m/Y H:i" }}</p>

  <!-- üîä ‡∏ü‡∏±‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö -->
  <div class="mt-4">
    <h5>üéß ‡∏ü‡∏±‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</h5>
    <audio controls class="w-100 mt-2">
      <source src="{{ audio.original_file.url }}" type="audio/mpeg">
      ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
    </audio>
  </div>

  <!-- üîä ‡∏ü‡∏±‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
  {% if outputs %}
  <div class="mt-4">
    <h5>üéöÔ∏è ‡∏°‡∏¥‡∏Å‡∏ã‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡πÄ‡∏•‡πà‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô)</h5>

    <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô -->
    <div class="mb-3">
      <button id="playAll" class="btn btn-primary me-2">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô</button>
      <button id="pauseAll" class="btn btn-secondary">‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
    </div>

    <!-- Audio players -->
    <div id="audioPlayers">
      {% for out in outputs %}
      <div class="mb-3">
        <h6>{{ out.stem_type|title }}</h6>
        <audio id="audio_{{ out.stem_type }}" controls class="w-100 mt-1">
          <source src="{{ out.file.url }}" type="audio/wav">
        </audio>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<hr>
<h5>üè∑Ô∏è ‡πÅ‡∏ó‡πá‡∏Å‡πÄ‡∏û‡∏•‡∏á</h5>
<form method="post">
  {% csrf_token %}
  <select name="tags" multiple class="form-select mb-3">
    {% for tag in tags %}
    <option value="{{ tag.id }}" {% if tag in audio.tags.all %}selected{% endif %}>{{ tag.name }}</option>
    {% endfor %}
  </select>
  {% if perms.audio.change_audiofile and is_owner%}
  <button class="btn btn-primary">üíæ Save Tag</button>
  {% endif %}
  {% if not request.user.is_staff %}
  <a href="{% url 'dashboard' %}" class="btn btn-secondary">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</a>
  {% else %}
  <a href="{% url 'admin_view_history' audio.owner.user.id %}" class="btn btn-secondary">‚¨Ö ‡∏Å‡∏•‡∏±‡∏ö</a>
  {% endif %}

</form>
</div>
<script>
  const playBtn = document.getElementById("playAll");
  const pauseBtn = document.getElementById("pauseAll");
  const vocals = document.getElementById("audio_vocals");
  const accomp = document.getElementById("audio_accompaniment");

  if (vocals && accomp) {
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î "‡πÄ‡∏•‡πà‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô"
    playBtn.addEventListener("click", () => {
      // sync ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô
      const currentTime = Math.max(vocals.currentTime, accomp.currentTime);
      vocals.currentTime = accomp.currentTime = currentTime;
      vocals.play();
      accomp.play();
    });

    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î "‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"
    pauseBtn.addEventListener("click", () => {
      vocals.pause();
      accomp.pause();
    });

    // ‡∏ñ‡πâ‡∏≤ track ‡πÉ‡∏î‡∏à‡∏ö ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡∏µ‡∏Å track ‡∏î‡πâ‡∏ß‡∏¢
    vocals.addEventListener("ended", () => accomp.pause());
    accomp.addEventListener("ended", () => vocals.pause());
  }
</script>
{% endblock %}